# The metadata script is outputing information about the model
# This information is parsed by the PHP script and stored in node fields 
# set globing mode; sequence with concat to suppress output of set
set glob_compat_mode 0; concat

# get parameters sent from Drupal
set image $::env(image); set views $::env(views); set size $::env(size); set objects $::env(objects); concat

# Output the database version
puts DATABASE:VERSION
dbversion
puts DATABASE:VERSION

# Output the one-line text of title
puts DATABASE:TITLE 
title
puts DATABASE:TITLE

# Output the units text
puts DATABASE:UNITS
regexp "You are editing in '(\\w+)'." [units] out units; puts $units
puts DATABASE:UNITS

# Output the summary
puts DATABASE:SUMMARY
regsub -all "\n\ +" [string trim [string map {Summary:\n ""} [summary]]] "; "
puts DATABASE:SUMMARY

# Output the tree
puts DATABASE:OBJECTS
ls -l
puts DATABASE:OBJECTS

# prepare to render the views
if {$objects == "*"} then {
  set objects [tops -n]; concat
}
# zapp the drawing area
Z
# draw objects
foreach x $objects { 
  if {$x != "_GLOBAL"} {
    draw $x
  } 
}

puts DATABASE:RAYTRACE
set offset 0; concat
foreach view [split $views ":"] {
  # set the view 
  ae $view

  # auto set the viewing size 
  autoview

  # zoom in just a bit
  zoom 1.2

  # raytrace the model
  rt -s $size -v 0 -o "${image}${offset}.pix"
  
  incr offset; concat 
}
puts DATABASE:RAYTRACE
